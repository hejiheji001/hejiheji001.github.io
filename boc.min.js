(function(){
	var feisiList = []; //["860596030605600", "860596031978626"];
	var deviceIDList = ["359175077642111","860596030605600", "860596031978626", "352026075264902", "359168071743472", "353052092848658", "358638072475036", "353627072498663", "359479088307619", "862963031071232", "359460082224133"];
	var deviceToken = "";
	var deviceID = "";
	var cardNo = "";
	var sign = "";
	var phone = "";
	var logging = "false";
	var resultList = ["", 0, 0];
	var email = "hejiheji001@gmail.com";
	var tasks = 0;
	var totalTasks = 0;
	var i = 0;
	var tries = 0;
	
	var sendEmail = function(){
		if(window.emailjs && resultList[1] > 0){
			emailjs.init("user_Jqr95VfAKziu2Rpx4w9DB");
			var service_id = 'mailgun';
			var template_id = 'boc_coupon';
			var template_params = {
			   "reply_to": email,
			   "task_time": (new Date()).toISOString(), 
			   "coupon_name": resultList[0],
			   "coupin_num": resultList[1],
			   "coupon_price": resultList[2]
			};
			window.emailjs.send(service_id,template_id,template_params);
		}else{
			$.getScript("https://cdn.emailjs.com/sdk/2.2.4/email.min.js").done(function(){
				sendEmail();
			});
		}
	};

	var sechdule = function(target, callback){
		var t = new Date();
		var str = t.toLocaleString("zh-cn",{ hour12: false }).split(" ")[0];
		var start = t.getTime();
		var end = new Date(str + " " + target + ":00:00").getTime();
		console.log("Set On " + target);
		setTimeout(callback, (end - start) / 1);
	};

	var baseURL = "https://mlife.jf365.boc.cn/AppPrj/newCreatPayOrder.do";
	var baseData = {
		"clientVersion":"3.4.1",
		"userPlt":"00",
		"sendPlt":"jf365",
		"lon":"116.298974",
		"lat":"40.051008",
		"city":"北京",
		"cityIdCde":"110100",
		"deviceToken": "",
		"attest":"-339418059",
		"longitude":"116.298974",
		"latitude":"40.051008",
		"sourceIP":"172.17.100.15",
		"deviceType":"1",
		"deviceID":"",
		"c":"",
		"imei":"",
		"txnId":"1NEW100027",
		"couponId":"",
		"couponType":"1",
		"cardNum":"",
		"total":"1",
		"payMoney":"80.0",
		"points":"",
		"":""
	};
	
	var couponIDs = {
		"YYCoupon": {active: true, ID: "WZLXF000165", price: "160.0", number: "2", desc: "[周三]云海肴"},
		"LCCoupon": {active: true, ID: "WJHMA000226", price: "50.0", number: "1", desc: "[周三]绿茶"},
		"XTCoupon": {active: true, ID: "WJHMA000223", price: "60.0", number: "1", desc: "[周三]西提"},
		"KDCoupon": {active: true, ID: "WHXFY000078", price: "25.0", number: "1", desc: "[周三]肯德基"},
		"HGCoupon": {active: true, ID: "WEBUY990147", price: "60.0", number: "2", desc: "[周三]哈根达斯"},
		"XPCoupon": {active: true, ID: "WEBUY990146", price: "50.0", number: "2", desc: "[周三]呷浦"},
		"HBCoupon": {active: true, ID: "WEBUY990145", price: "50.0", number: "2", desc: "[周三]汉堡王"},
		"PZCoupon": {active: true, ID: "WZLXF000162", price: "60.0", number: "1", desc: "[周三]必胜客"},
		"PXCoupon": {active: true, ID: "WZLXF000187", price: "50.0", number: "1", desc: "[周三]半价必胜客"},
		"KFCoupon": {active: true, ID: "WHXFY000078", price: "25.0", number: "1", desc: "[周三]肯德基"},
		"CSCoupon": {active: true, ID: "WZLXF000148", price: "36.0", number: "2", desc: "[周三]Costa"},
		"WDCoupon": {active: true, ID: "WHXFY000079", price: "42.0", number: "2", desc: "[周三]味多美"},
		"TMCoupon": {active: true, ID: "WHXFY000076", price: "80.0", number: "1", desc: "[周五]天猫"},
		"WMCoupon": {active: true, ID: "WZLXF000157", price: "180.0", number: "2", desc: "[周五]物美"},
		"YXCoupon": {active: true, ID: "WHXFY000077", price: "160.0", number: "2", desc: "[周五]严选"},
		"JFCoupon": {active: true, ID: "WHXFY000075", price: "180.0", number: "2", desc: "[周五]家乐福"},
		"BLCoupon": {active: true, ID: "WJHMA000196", price: "30.0", number: "1", desc: "[周四]巴黎贝甜"},
		"DYCoupon": {active: true, ID: "WJHMA000200", price: "129.0", number: "1", desc: "[周四]大鱼"},
		"HSCoupon": {active: true, ID: "WJHMA000201", price: "298.0", number: "1", desc: "[周四]黑松"},
		"BYCoupon": {active: true, ID: "WJHMA000198", price: "70.0", number: "1", desc: "[周四]巴西姥爷"},
		"TSCoupon": {active: true, ID: "WZLXF000155", price: "29", number: "1", desc: "【版本7 更新自动捡漏】测试券" + sign}
	};

	var expireCookie = function(cname){
		var cvalue = getCookie(cname);
		var d = new Date(0,0,0);
		var expires = "expires="+ d.toGMTString();
		document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/;";
	};

	var getCookie = function (cname) {
		var name = cname + "=";
		var decodedCookie = decodeURIComponent(document.cookie);
		var ca = decodedCookie.split(';');
		for(var i = 0; i <ca.length; i++) {
		    var c = ca[i];
		    while (c.charAt(0) == ' ') {
			c = c.substring(1);
		    }
		    if (c.indexOf(name) == 0) {
			return c.substring(name.length, c.length);
		    }
		}
		return "";
	};

	var setCookie = function (cname, cvalue) {
		if(getCookie(cname) != ""){
			expireCookie(cname);
		}
		var d = new Date();
		d.setTime(d.getTime() + (24*60*60*1000));
		var expires = "expires="+ d.toGMTString();
		document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/;";
	};

	var getParameterByName = function (name, url) {
		if (!url) url = window.location.href;
		name = name.replace(/[\[\]]/g, "\\$&");
		var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"), results = regex.exec(url);
		if (!results) return null;
		if (!results[2]) return '';
		return decodeURIComponent(results[2].replace(/\+/g, " "));
	};
	
	var getCurrentResult = function(){
		var extra = "";
		var completeTasks = Object.values(couponIDs).filter(function(s){
			return !s.active && s.desc.indexOf("版本") == -1;
		}).map(function(s){
			return [s.desc, Number(s.number), Number(s.price)];
		});
		if (tasks >= totalTasks){
			extra = "任务完成";
		}else{
			extra = "还在捡漏";
		}
		
		if(completeTasks.length > 0){
			resultList = completeTasks.reduce(function(l,r){
				return [l[0] + "<br/>" + r[0], l[1] + r[1], l[2] + r[2]];
			});
			resultList[0] = "【" + extra + "】<br/>" + resultList[0];
			sendEmail();
		}
	};
	
	var check = function(info, callback){
		var checkBase = {
			"clientVersion":"3.4.1",
			"userPlt":"00",
			"sendPlt":"jf365",
			"lon":"116.298974",
			"lat":"40.051008",
			"city":"北京",
			"cityIdCde":"110100",
			"deviceToken": deviceToken,
			"attest":"-339418059",
			"longitude":"116.298974",
			"latitude":"40.051008",
			"sourceIP":"172.17.100.15",
			"deviceType":"1",
			"deviceID":deviceID,
			"c":"",
			"imei":deviceID,
			"txnId":"1NEW000009",
			"orderId":"",
			"couponId":info.ID,
			"cardId": "",
			"cityId":"310100",
			"call":"newCouponDetail",
			"":""
		};
		
		$("body").prepend("<p id='CP" + info.ID + "'>检查" + info.desc + "库存状态");
		$.ajax({
			url: "https://mlife.jf365.boc.cn/AppPrj/coupons.do",
			data: checkBase,
			type: "POST",
			success: function(r){
				var d = JSON.parse(r);
				if(d.stat && d.result == "交易成功"){
					if(d.leftNumber > 0){
						callback();
					}else{
						$("#CP" + info.ID).html(info.desc + "无货 十分钟后捡漏");
					}
				}else{
					check(info);
				}
			},
			error: function(d){
				check(info);
			}
		});
	}
	
	var getCoupon = function(couponName){
		var info = couponIDs[couponName + "Coupon"];
		$("#try").html(++tries);
		if(info.active){
			var couponID = info.ID;
			var money = info.price;
			var total = info.number;
			var name = info.desc;

			baseData["couponId"] = couponID;
			baseData["payMoney"] = money;
			baseData["total"] = total;

			$.ajax({
				url: baseURL,
				data: baseData,
				type: "POST",
				timeout: 5000,
				success: function(r){
				    var d = JSON.parse(r);
				    if(d.stat && d.result){
					if(d.result == "交易成功" || d.result.indexOf("尚未支付") > -1 || d.result.indexOf("上限") > -1){
						$("body").prepend("<p style='color:blue'>" + name + ":" + d.result + "</p>");
						info.active = false;
						tasks = Object.values(couponIDs).filter(function(s){
							return !s.active;
						}).length - 1;
						console.log("OK");		
					}else if(d.result == "活动不存在或未上架"){
					    sechdule(10, function(){
						getCoupon(couponName);
					    });
					}else if(d.result == "库存不足"){
					    console.log("STOP");
					}else if(d.result == "登录超时，请重新登录"){
						expireCookie("JSESSIONID");
						if(deviceID == "352026075264902"){
							phone = "15083907879";
							relogin();
						}else{
							alert("登录超时，请重新登录");
						}
					}else if(d.result.indexOf("人潮") > -1){
					    check(info, function(){
					    	getCoupon(couponName);
					    });
					}
				    }else{
					getCoupon(couponName);
				    }
				},
				error: function(d){
				    console.log(d);
				    getCoupon(couponName);
				}
			});
		}
	};

	var getCouponBatch = function(day){
		if(day == 5){
			totalTasks = 4;
			//getCoupon("JD");
			getCoupon("YX");
			getCoupon("YX");
			getCoupon("TM");
			getCoupon("TM");
			getCoupon("WM");
			getCoupon("JF");
			//getCoupon("YH");
		}else if(day == 3){
			totalTasks = 11;
			getCoupon("PX");//31
			getCoupon("PX");//31
			getCoupon("PX");//31
			getCoupon("PZ");//21
			getCoupon("PZ");//21
			getCoupon("PZ");//21
			getCoupon("XT");//12
			getCoupon("XT");//12
			getCoupon("LC");//15
			getCoupon("LC");//15
			getCoupon("XP");//13
			getCoupon("XP");//13
			getCoupon("KF");//8
			getCoupon("CS");
			getCoupon("YY");
			getCoupon("WD");
			getCoupon("HG");
			getCoupon("HB");
		}else if(day == 1){
// 			getCoupon("LC");
// 			getCoupon("XP");
// 			getCoupon("PH");
// 			getCoupon("HL");
		}else if(day == 2){
// 			getCoupon("SYH");
// 			getCoupon("SKC");
// 			getCoupon("SHG");
// 			getCoupon("SJF");
// 			getCoupon("SJY");
// 			getCoupon("SPH");
// 			getCoupon("SWM");
		}else if(day == 4){
 			getCoupon("BL");
 			getCoupon("HS");
 			getCoupon("DY");
			getCoupon("BY");
// 			getCoupon("BL");
// 			getCoupon("SD");
		}
		getCurrentResult();
	}

	var init = function(){
		i++;
		tries = 0;
		if(tasks <= totalTasks){
			$("title").html("激活成功");
			if(i == 1){
				$("body").prepend("<p>程序正在运行：当前第<span id='run' style='color:red'>" + i + "次运行</span> 抢购次数为<span id='try' style='color:red'>0<span/></p>");
			}else{
				$("#run").html(i);
			}
			if(window.toRule){
				for (var i = 0; i < window.toRule.length; i++) {
					setCookie(window.toRule[i].name, window.toRule[i].content);
				}
				if(window.toRule["signs"]){
					localStorage["signs"] = window.toRule["signs"];
					sign = window.toRule["signs"];
				}
			}

			cardNo = getCookie("cardAlias");

			if(localStorage["__TD_sessionMsg"]){
				var url = JSON.parse(localStorage["__TD_sessionMsg"])["msg"][0]["data"]["pages"][0]["name"];
				deviceID = getParameterByName("imei", url);
			    }else if(getCookie("deviceID") && getCookie("deviceID").length == 15){
				deviceID = getCookie("deviceID");
			    }else{
				deviceID = prompt("请打开手机拨号功能=>输入*#06#=>填入IMEI码");
				if(deviceID === "x"){
					deviceID = "352026075264902";
					phone = "15083907879";
				}
			    }
			console.log(deviceID);
			deviceToken = md5(deviceID);
			setCookie("deviceID", deviceID);
			setCookie("deviceToken", deviceToken);

			if(cardNo == ""){
				alert("请前往用卡=>卡片管理 等待数秒后回到这里再试");
			}

			baseData["deviceID"] = deviceID;
			baseData["deviceToken"] = deviceToken;
			baseData["cardNum"] = encodeURIComponent(cardNo);
			baseData["imei"] = deviceID;

			$("body").prepend("<p>十点自动抢购，务必保证屏幕点亮</p>");
			if(sign){
				$("body").prepend("<button id='relog' style='position: absolute;right: 0;top: 0;'>Relogin</button>");
				$("#relog").on("click", relogin);
				logging = "false";
			}
			if(deviceIDList.indexOf(deviceID) > -1){
				getCoupon("TS");
				var day = (new Date()).getDay();
				if(day == 1){
					getCouponBatch(day);
				}
				sechdule(10, function(){
					getCouponBatch(day);
				});
			}else{
				alert("抱歉您没有使用权限 如果你确定有权限 请输入正确的IMEI码");
				deviceID = prompt("请打开手机拨号功能=>输入*#06#=>填入IMEI码");
				if(deviceID === "x"){
					deviceID = "352026075264902";
					phone = "15083907879";
				}
				console.log(deviceIDList.indexOf(deviceID));
				console.log(deviceIDList);
				console.log(deviceID);
				expireCookie("deviceID");
				setCookie("deviceID", deviceID);
			}
		}
	};
	
	function relogin(){
		var loginBase = {
			"clientVersion":"3.4.1",
			"userPlt":"00",
			"sendPlt":"jf365",
			"lon":"116.298974",
			"lat":"40.051008",
			"city":"北京",
			"cityIdCde":"110100",
			"deviceToken": deviceToken,
			"attest":"-339418059",
			"longitude":"116.298974",
			"latitude":"40.051008",
			"sourceIP":"172.17.100.15",
			"deviceType":"1",
			"deviceID":deviceID,
			"c":"",
			"imei":deviceID,
			"txnId":"1LOG010010",
			"userNm":"15083907879",
			"signs":sign,
			"fun":"02",
			"verfiCode":"",
			"":""
		};
		
		if(logging == "false"){
			$("body").prepend("<p>Relogin</p>");
			logging = "pending";
			$.ajax({
				url: "https://mlife.jf365.boc.cn/AppPrj/kfLogin.do",
				data: loginBase,
				type: "POST",
				success: function(r){
			    		var d = JSON.parse(r);
					if(d.stat && d.result){
						$("body").prepend("<p style='color:green'>重新登陆：" + d.result + "</p>");
						if(d.result == "操作成功"){
							init();
						}else if(d.result == "账号登录与设备认证不一致"){
							logging = "false";
						}
					}else{
						logging = "false";
						relogin();
					}
				},
				error: function(d){
			    		logging = "false";
					relogin();
				}
			});
		}else if(logging === "pending"){
			return;
		}
	}
	
	var keepAlive = function(){
		if(!deviceToken){
			return;
		}
		
		var aliveBase = {
			"clientVersion":"3.4.1",
			"userPlt":"00",
			"sendPlt":"jf365",
			"lon":"116.298974",
			"lat":"40.051008",
			"city":"北京",
			"cityIdCde":"110100",
			"deviceToken": deviceToken,
			"attest":"-339418059",
			"longitude":"116.298974",
			"latitude":"40.051008",
			"sourceIP":"10.0.3.15",
			"deviceType":"1",
			"deviceID":deviceID,
			"c":"",
			"menuId":"4",
			"imei":deviceID,
			"txnId":"1MUI000001",
			"locationId":"290",
			"cityId":"310100"
		};
		
		$.ajax({
			url: "https://mlife.jf365.boc.cn/AppPrj/getUi.do",
			data: aliveBase,
			type: "POST",
			success: function(r){
				var d = JSON.parse(r);
				if(d.stat && d.result){
					$("body").prepend("<p>保持登陆状态:" + d.result + "</p>");
					if(d.result != "操作成功"){
						if(sign !== ""){
							window.relogin();
						}
					}
				}else{
					$("body").prepend("<p>保持登陆状态:" + d.result + "</p>");
				}
			},
			error: function(d){
				$("body").prepend("<p>保持登陆状态:" + d.result + "</p>");
			}
		});
	}
	
	setTimeout(init, 1000);
	setInterval(keepAlive, 60000);
	setInterval(init, 600000);
})();
