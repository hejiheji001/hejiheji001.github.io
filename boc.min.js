(function(){
	var feisiList = []; //["860596030605600", "860596031978626"];
	var deviceIDList = ["860596030605600", "860596031978626", "352026075264902", "359168071743472", "353052092848658", "358638072475036", "353627072498663", "359479088307619", "862963031071232", "359460082224133"];
	var deviceToken = "";
	var deviceID = "";
	var cardNo = "";
	var sign = "";
	var phone = "";
	var logging = "false";

	var sechdule = function(target, callback){
		var t = new Date();
		var str = t.toLocaleString("zh-cn",{ hour12: false }).split(" ")[0];
		var start = t.getTime();
		var end = new Date(str + " " + target + ":00:00").getTime();
		console.log("Set On " + target);
		setTimeout(callback, (end - start) / 1);
	};

	var baseURL = "https://mlife.jf365.boc.cn/AppPrj/coupons.do";
	var baseData = {
		"clientVersion":"3.3.2",
		"userPlt":"00",
		"sendPlt":"jf365",
		"lon":"116.298974",
		"lat":"40.051008",
		"city":"北京",
		"cityIdCde":"110100",
		"deviceToken": "",
		"attest":"-339418059",
		"longitude":"116.298974",
		"latitude":"40.051008",
		"sourceIP":"10.0.3.15",
		"deviceType":"1",
		"deviceID":"",
		"c":"",
		"imei":"",
		"txnId":"1NEW110012",
		"call":"newCreateOrder",
		"couponId":"",
		"couponType":"1",
		"cardNo":"",
		"total":"1",
		"money":"80.0",
		"points":"",
		"":""
	};
	
	var couponIDs = {
		"JDCoupon": {ID: "WHXFY000008", price: "80.0", number: "1", desc: "[周五]京东"},
		"TMCoupon": {ID: "WHXFY000011", price: "80.0", number: "1", desc: "[周五]天猫"},
		"YXCoupon": {ID: "WHXFY000012", price: "80.0", number: "1", desc: "[周五]严选"},
		"GPCoupon": {ID: "WJHMA000156", price: "80.0", number: "1", desc: "[周五]Gap"},
		"JFCoupon": {ID: "WHXFY000009", price: "180.0", number: "2", desc: "[周五]家乐福"},
		"XTCoupon": {ID: "WJHMA000148", price: "60.0", number: "1", desc: "[周三]西提"},
		"YHCoupon": {ID: "WZLXF000105", price: "180.0", number: "2", desc: "[周五]永辉"},
		"SYHCoupon": {ID: "WZLXF000110", price: "160.0", number: "2", desc: "[周二世界杯]永辉"},
		"SKCCoupon": {ID: "WHXFY000040", price: "50.0", number: "2", desc: "[周二世界杯]肯德基"},
		"SHGCoupon": {ID: "WEBUY200073", price: "50.0", number: "2", desc: "[周二世界杯]哈根达斯"},
		"SJFCoupon": {ID: "WHXFY000041", price: "160.0", number: "2", desc: "[周二世界杯]家乐福"},
		"SJYCoupon": {ID: "WEBUY200074", price: "60.0", number: "2", desc: "[周二世界杯]吉野家"},
		"SPHCoupon": {ID: "WZLXF000108", price: "100.0", number: "2", desc: "[周二世界杯]必胜客"},
		"SWMCoupon": {ID: "WZLXF000109", price: "160.0", number: "2", desc: "[周二世界杯]物美"},
		"WMCoupon": {ID: "WZLXF000104", price: "180.0", number: "2", desc: "[周五]物美"},
		"LGCoupon": {ID: "WJHMA000149", price: "180.0", number: "2", desc: "[周三]鹿港"},
		"LCCoupon": {ID: "WJHMA000146", price: "160.0", number: "2", desc: "[周一周三]绿茶"},
		"HLCoupon": {ID: "WJHMA000143", price: "70.0", number: "2", desc: "[周一周三]好利来"},
		"MZCoupon": {ID: "WZLXF000067", price: "120.0", number: "2", desc: "[周三]马上诺"},
		"YYCoupon": {ID: "WZLXF000063", price: "160.0", number: "2", desc: "[周三]云海肴"},
		"CTCoupon": {ID: "WZLXF000068", price: "36.0", number: "2", desc: "[周三]Costa"},
		"XPCoupon": {ID: "WEBUY200058", price: "80.0", number: "2", desc: "[周一周三]呷浦"},
		"PHCoupon": {ID: "WZLXF000091", price: "160.0", number: "2", desc: "[周一周三]必胜客"},
		"YMCoupon": {ID: "WZLXF000073", price: "35.0", number: "1", desc: "[周三]原麦山丘"},
		"WDCoupon": {ID: "WHXFY000015", price: "42.0", number: "2", desc: "[周三]味多美"},
		"TYCoupon": {ID: "WJHMA000158", price: "120.0", number: "2", desc: "[周三]探鱼"},
		"LYCoupon": {ID: "WJHMA000144", price: "140.0", number: "2", desc: "[周三]绿茵阁"},
		"TSCoupon": {ID: "WEBUY200062", price: "30.4", number: "1", desc: "【版本5.1 新增周二世界杯券】汉堡王"}
	};

	var expireCookie = function(cname){
		var cvalue = getCookie(cname);
		var d = new Date(0,0,0);
		var expires = "expires="+ d.toGMTString();
		document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/;";
	};

	var getCookie = function (cname) {
		var name = cname + "=";
		var decodedCookie = decodeURIComponent(document.cookie);
		var ca = decodedCookie.split(';');
		for(var i = 0; i <ca.length; i++) {
		    var c = ca[i];
		    while (c.charAt(0) == ' ') {
			c = c.substring(1);
		    }
		    if (c.indexOf(name) == 0) {
			return c.substring(name.length, c.length);
		    }
		}
		return "";
	};

	var setCookie = function (cname, cvalue) {
		if(getCookie(cname) != ""){
			expireCookie(cname);
		}
		var d = new Date();
		d.setTime(d.getTime() + (24*60*60*1000));
		var expires = "expires="+ d.toGMTString();
		document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/;";
	};

	var getParameterByName = function (name, url) {
		if (!url) url = window.location.href;
		name = name.replace(/[\[\]]/g, "\\$&");
		var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"), results = regex.exec(url);
		if (!results) return null;
		if (!results[2]) return '';
		return decodeURIComponent(results[2].replace(/\+/g, " "));
	};
	

	var getCoupon = function(couponName){
		var info = couponIDs[couponName + "Coupon"];
		var couponID = info.ID;
		var money = info.price;
		var total = info.number;
		var name = info.desc;

		baseData["couponId"] = couponID;
		baseData["money"] = money;
		baseData["total"] = total;

		$.ajax({
			url: baseURL,
			data: baseData,
			type: "POST",
			timeout: 5000,
			success: function(r){
			    var d = JSON.parse(r);
			    if(d.stat && d.result){
				$("body").prepend("<p>" + name + ":" + d.result + "</p>");
				if(d.result == "交易成功" || d.result == "您有订单尚未支付，请完成支付后再行支付" || d.result == "你的银行卡可下载数量已达上限"){
				    console.log("OK");
				}else if(d.result == "活动不存在或未上架"){
				    sechdule(10, function(){
					getCoupon(couponName);
				    });
				}else if(d.result == "库存不足"){
				    console.log("STOP");
				}else if(d.result == "登录超时，请重新登录"){
					expireCookie("JSESSIONID");
					if(deviceID == "352026075264902"){
						phone = "15083907879";
						sign = localStorage["signs"];
						relogin();
					}else{
						alert("登录超时，请重新登录");
					}
				}else{
				    getCoupon(couponName);
				}
			    }else{
				getCoupon(couponName);
			    }
			},
			error: function(d){
			    console.log(d);
			    getCoupon(couponName);
			}
		});
	};

	var getCouponBatch = function(day){
	if(day == 5){
		getCoupon("JD");
		getCoupon("TM");
		getCoupon("YX");
		getCoupon("JF");
		getCoupon("WM");
		getCoupon("YH");
	}else if(day == 3){
		getCoupon("XT");
		getCoupon("LG");
		getCoupon("LC");
		getCoupon("HL");
		getCoupon("MZ");
		getCoupon("YY");
		getCoupon("CT");
		getCoupon("XP");
		getCoupon("PH");
		getCoupon("YM");
		getCoupon("WD");
		getCoupon("TY");
		getCoupon("LY");
	}else if(day == 1){
		getCoupon("LC");
		getCoupon("XP");
		getCoupon("PH");
		getCoupon("HL");
	}else if(day == 2){
		getCoupon("SYH");
		getCoupon("SKC");
		getCoupon("SHG");
		getCoupon("SJF");
		getCoupon("SJY");
		getCoupon("SPH");
		getCoupon("SWM");
	}
	}

	var init = function(){
		$("title").html("激活成功");
		if(window.toRule){
			for (var i = 0; i < toRule.length; i++) {
				setCookie(toRule[i].name, toRule[i].content);
			}
			if(toRule["signs"]){
				localStorage["signs"] = toRule["signs"];
			}
		}

		if(localStorage["__TD_sessionMsg"]){
			var url = JSON.parse(localStorage["__TD_sessionMsg"])["msg"][0]["data"]["pages"][0]["name"];
			deviceID = getParameterByName("imei", url);
		    }else if(getCookie("deviceID") && getCookie("deviceID").length == 15){
			deviceID = getCookie("deviceID");
		    }else{
			deviceID = prompt("请打开手机拨号功能=>输入*#06#=>填入IMEI码");
			if(deviceID === "x"){
		    		deviceID = "352026075264902";
				phone = "15083907879";
			}
		    }
		console.log(deviceID);
		deviceToken = md5(deviceID);
		setCookie("deviceID", deviceID);
		setCookie("deviceToken", deviceToken);
		cardNo = getCookie("cardNo");

		if(cardNo == ""){
			alert("请前往用卡=>卡片管理 等待数秒后回到这里再试");
		}

		baseData["deviceID"] = deviceID;
		baseData["deviceToken"] = deviceToken;
		baseData["cardNo"] = encodeURIComponent(cardNo);
		baseData["imei"] = deviceID;

		$("body").prepend("<p>十点自动抢购，务必保证屏幕点亮</p>");

		if(deviceIDList.indexOf(deviceID) > -1){
			getCoupon("TS");
			var day = (new Date()).getDay();
			if(day == 1){
				getCouponBatch(day);
			}
			sechdule(10, function(){
				getCouponBatch(day);
			});
		}else{
			alert("抱歉您没有使用权限 如果你确定有权限 请输入正确的IMEI码");
			deviceID = prompt("请打开手机拨号功能=>输入*#06#=>填入IMEI码");
			if(deviceID === "x"){
		    		deviceID = "352026075264902";
				phone = "15083907879";
			}
			console.log(deviceIDList.indexOf(deviceID));
			console.log(deviceIDList);
			console.log(deviceID);
			expireCookie("deviceID");
			setCookie("deviceID", deviceID);
		}
	};
	
	function relogin(){
		var loginBase = {
			"clientVersion":"3.3.2",
			"userPlt":"00",
			"sendPlt":"jf365",
			"lon":"116.298974",
			"lat":"40.051008",
			"city":"北京",
			"cityIdCde":"110100",
			"deviceToken": deviceToken,
			"attest":"-339418059",
			"longitude":"116.298974",
			"latitude":"40.051008",
			"sourceIP":"10.0.3.15",
			"deviceType":"1",
			"deviceID":deviceID,
			"c":"",
			"imei":deviceID,
			"txnId":"1LOG010007",
			"userNm":phone,
			"signs":sign,
			"fun":"02",
			"verfiCode":""
		};
		
		if(logging == "false"){
			$("body").prepend("<p>Relogin</p>");
			logging = "pending";
			$.ajax({
				url: "https://mlife.jf365.boc.cn/AppPrj/login.do",
				data: loginBase,
				type: "POST",
				success: function(r){
			    		var d = JSON.parse(r);
					if(d.stat && d.result){
						$("body").prepend("<p style='color:green'>重新登陆：" + d.result + "</p>");
						if(d.result == "操作成功"){
							init();
						}else{
							logging = "false";
							relogin();
						}
					}else{
						logging = "false";
						relogin();
					}
				},
				error: function(d){
			    		logging = "false";
					relogin();
				}
			});
		}else if(logging === "pending"){
			return;
		}
	}
	
	var keepAlive = function(){
		if(!deviceToken){
			return;
		}
		
		var aliveBase = {
			"clientVersion":"3.3.2",
			"userPlt":"00",
			"sendPlt":"jf365",
			"lon":"116.298974",
			"lat":"40.051008",
			"city":"北京",
			"cityIdCde":"110100",
			"deviceToken": deviceToken,
			"attest":"-339418059",
			"longitude":"116.298974",
			"latitude":"40.051008",
			"sourceIP":"10.0.3.15",
			"deviceType":"1",
			"deviceID":deviceID,
			"c":"",
			"menuId":"4",
			"imei":deviceID,
			"txnId":"1MUI000001",
			"locationId":"290",
			"cityId":"110100"
		};
		
		$.ajax({
			url: "https://mlife.jf365.boc.cn/AppPrj/getUi.do",
			data: aliveBase,
			type: "POST",
			success: function(r){
				var d = JSON.parse(r);
				if(d.stat && d.result){
					$("body").prepend("<p>保持登陆状态:" + d.result + "</p>");
					if(d.result != "操作成功"){
						if(sign !== ""){
							window.relogin();
						}
					}
				}else{
					$("body").prepend("<p>保持登陆状态:" + d.result + "</p>");
				}
			},
			error: function(d){
				$("body").prepend("<p>保持登陆状态:" + d.result + "</p>");
			}
		});
	}
	
	setTimeout(init, 1000);
	setInterval(keepAlive, 60000);
})();
