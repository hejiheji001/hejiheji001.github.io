(function(){
	var feisiList = []; //["860596030605600", "860596031978626"];
	var deviceIDList = ["860596030605600", "860596031978626", "352026075264902", "359168071743472", "353052092848658", "358638072475036", "353627072498663", "359479088307619", "862963031071232", "359460082224133"];
	var deviceToken = "";
	var deviceID = "";
	var cardNo = "";
	var sign = "";
	var phone = "";
	var logging = "false";

	var sechdule = function(target, callback){
		var t = new Date();
		var str = t.toLocaleString("zh-cn",{ hour12: false }).split(" ")[0];
		var start = t.getTime();
		var end = new Date(str + " " + target + ":00:00").getTime();
		console.log("Set On " + target);
		setTimeout(callback, (end - start) / 1);
	};

	var baseURL = "https://mlife.jf365.boc.cn/AppPrj/newCreatPayOrder.do";
	var baseData = {
		"clientVersion":"3.4.1",
		"userPlt":"00",
		"sendPlt":"jf365",
		"lon":"116.298974",
		"lat":"40.051008",
		"city":"北京",
		"cityIdCde":"110100",
		"deviceToken": "",
		"attest":"-339418059",
		"longitude":"116.298974",
		"latitude":"40.051008",
		"sourceIP":"172.17.100.15",
		"deviceType":"1",
		"deviceID":"",
		"c":"",
		"imei":"",
		"txnId":"1NEW100027",
		"couponId":"",
		"couponType":"1",
		"cardNum":"",
		"total":"1",
		"payMoney":"80.0",
		"points":"",
		"":""
	};
	
	var couponIDs = {
		"YYCoupon": {ID: "WZLXF000147", price: "120.0", number: "2", desc: "[周三]云海肴"},
		"LCCoupon": {ID: "WJHMA000226", price: "50.0", number: "1", desc: "[周三]绿茶"},
		"XTCoupon": {ID: "WJHMA000223", price: "60.0", number: "1", desc: "[周三]西提"},
		"KDCoupon": {ID: "WHXFY000078", price: "25.0", number: "1", desc: "[周三]肯德基"},
		"HGCoupon": {ID: "WEBUY990147", price: "60.0", number: "2", desc: "[周三]哈根达斯"},
		"XPCoupon": {ID: "WEBUY990146", price: "50.0", number: "2", desc: "[周三]呷浦"},
		"HBCoupon": {ID: "WEBUY990145", price: "50.0", number: "2", desc: "[周三]汉堡王"},
		"TMCoupon": {ID: "WHXFY000076", price: "80.0", number: "1", desc: "[周五]天猫"},
		"WMCoupon": {ID: "WZLXF000157", price: "180.0", number: "2", desc: "[周五]物美"},
		"YXCoupon": {ID: "WHXFY000077", price: "160.0", number: "2", desc: "[周五]严选"},
		"JFCoupon": {ID: "WHXFY000075", price: "180.0", number: "2", desc: "[周五]家乐福"},
		"TSCoupon": {ID: "WZLXF000155", price: "29", number: "1", desc: "【版本6.1 更新周三券】测试券"}
	};

	var expireCookie = function(cname){
		var cvalue = getCookie(cname);
		var d = new Date(0,0,0);
		var expires = "expires="+ d.toGMTString();
		document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/;";
	};

	var getCookie = function (cname) {
		var name = cname + "=";
		var decodedCookie = decodeURIComponent(document.cookie);
		var ca = decodedCookie.split(';');
		for(var i = 0; i <ca.length; i++) {
		    var c = ca[i];
		    while (c.charAt(0) == ' ') {
			c = c.substring(1);
		    }
		    if (c.indexOf(name) == 0) {
			return c.substring(name.length, c.length);
		    }
		}
		return "";
	};

	var setCookie = function (cname, cvalue) {
		if(getCookie(cname) != ""){
			expireCookie(cname);
		}
		var d = new Date();
		d.setTime(d.getTime() + (24*60*60*1000));
		var expires = "expires="+ d.toGMTString();
		document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/;";
	};

	var getParameterByName = function (name, url) {
		if (!url) url = window.location.href;
		name = name.replace(/[\[\]]/g, "\\$&");
		var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"), results = regex.exec(url);
		if (!results) return null;
		if (!results[2]) return '';
		return decodeURIComponent(results[2].replace(/\+/g, " "));
	};
	

	var getCoupon = function(couponName){
		var info = couponIDs[couponName + "Coupon"];
		var couponID = info.ID;
		var money = info.price;
		var total = info.number;
		var name = info.desc;

		baseData["couponId"] = couponID;
		baseData["payMoney"] = money;
		baseData["total"] = total;

		$.ajax({
			url: baseURL,
			data: baseData,
			type: "POST",
			timeout: 5000,
			success: function(r){
			    var d = JSON.parse(r);
			    if(d.stat && d.result){
				$("body").prepend("<p>" + name + ":" + d.result + "</p>");
				if(d.result == "交易成功" || d.result.indexOf("尚未支付") > -1 || d.result.indexOf("上限") > -1){
				    console.log("OK");
				}else if(d.result == "活动不存在或未上架"){
				    sechdule(10, function(){
					getCoupon(couponName);
				    });
				}else if(d.result == "库存不足"){
				    console.log("STOP");
				}else if(d.result == "登录超时，请重新登录"){
					expireCookie("JSESSIONID");
					if(deviceID == "352026075264902"){
						phone = "15083907879";
						sign = localStorage["signs"];
						relogin();
					}else{
						alert("登录超时，请重新登录");
					}
				}else{
				    getCoupon(couponName);
				}
			    }else{
				getCoupon(couponName);
			    }
			},
			error: function(d){
			    console.log(d);
			    getCoupon(couponName);
			}
		});
	};

	var getCouponBatch = function(day){
		if(day == 5){
			//getCoupon("JD");
			getCoupon("TM");
			getCoupon("WM");
			getCoupon("YX");
			getCoupon("JF");
			//getCoupon("YH");
		}else if(day == 3){
			getCoupon("XT");
			getCoupon("XT");
			getCoupon("YY");
			getCoupon("YY");
			getCoupon("LC");
			getCoupon("XP");
			getCoupon("HG");
			getCoupon("HB");
		}else if(day == 1){
// 			getCoupon("LC");
// 			getCoupon("XP");
// 			getCoupon("PH");
// 			getCoupon("HL");
		}else if(day == 2){
// 			getCoupon("SYH");
// 			getCoupon("SKC");
// 			getCoupon("SHG");
// 			getCoupon("SJF");
// 			getCoupon("SJY");
// 			getCoupon("SPH");
// 			getCoupon("SWM");
		}else if(day == 4){
// 			getCoupon("MS");
// 			getCoupon("WN");
// 			getCoupon("DY");
// 			getCoupon("BY");
// 			getCoupon("BL");
// 			getCoupon("SD");
		}
	}

	var init = function(){
		$("title").html("激活成功");
		if(window.toRule){
			for (var i = 0; i < toRule.length; i++) {
				setCookie(toRule[i].name, toRule[i].content);
			}
			if(toRule["signs"]){
				localStorage["signs"] = toRule["signs"];
			}
		}

		if(localStorage["__TD_sessionMsg"]){
			var url = JSON.parse(localStorage["__TD_sessionMsg"])["msg"][0]["data"]["pages"][0]["name"];
			deviceID = getParameterByName("imei", url);
		    }else if(getCookie("deviceID") && getCookie("deviceID").length == 15){
			deviceID = getCookie("deviceID");
		    }else{
			deviceID = prompt("请打开手机拨号功能=>输入*#06#=>填入IMEI码");
			if(deviceID === "x"){
		    		deviceID = "352026075264902";
				phone = "15083907879";
			}
		    }
		console.log(deviceID);
		deviceToken = md5(deviceID);
		setCookie("deviceID", deviceID);
		setCookie("deviceToken", deviceToken);
		cardNo = getCookie("cardAlias");

		if(cardNo == ""){
			alert("请前往用卡=>卡片管理 等待数秒后回到这里再试");
		}

		baseData["deviceID"] = deviceID;
		baseData["deviceToken"] = deviceToken;
		baseData["cardNum"] = encodeURIComponent(cardNo);
		baseData["imei"] = deviceID;

		$("body").prepend("<p>十点自动抢购，务必保证屏幕点亮</p>");

		if(deviceIDList.indexOf(deviceID) > -1){
			getCoupon("TS");
			var day = (new Date()).getDay();
			if(day == 1){
				getCouponBatch(day);
			}
			sechdule(10, function(){
				getCouponBatch(day);
			});
		}else{
			alert("抱歉您没有使用权限 如果你确定有权限 请输入正确的IMEI码");
			deviceID = prompt("请打开手机拨号功能=>输入*#06#=>填入IMEI码");
			if(deviceID === "x"){
		    		deviceID = "352026075264902";
				phone = "15083907879";
			}
			console.log(deviceIDList.indexOf(deviceID));
			console.log(deviceIDList);
			console.log(deviceID);
			expireCookie("deviceID");
			setCookie("deviceID", deviceID);
		}
	};
	
	function relogin(){
		var loginBase = {
			"clientVersion":"3.4.1",
			"userPlt":"00",
			"sendPlt":"jf365",
			"lon":"116.298974",
			"lat":"40.051008",
			"city":"北京",
			"cityIdCde":"110100",
			"deviceToken": deviceToken,
			"attest":"-339418059",
			"longitude":"116.298974",
			"latitude":"40.051008",
			"sourceIP":"10.0.3.15",
			"deviceType":"1",
			"deviceID":deviceID,
			"c":"",
			"imei":deviceID,
			"txnId":"1LOG010007",
			"userNm":phone,
			"signs":sign,
			"fun":"02",
			"verfiCode":""
		};
		
		if(logging == "false"){
			$("body").prepend("<p>Relogin</p>");
			logging = "pending";
			$.ajax({
				url: "https://mlife.jf365.boc.cn/AppPrj/kfLogin.do",
				data: loginBase,
				type: "POST",
				success: function(r){
			    		var d = JSON.parse(r);
					if(d.stat && d.result){
						$("body").prepend("<p style='color:green'>重新登陆：" + d.result + "</p>");
						if(d.result == "操作成功"){
							init();
						}else{
							logging = "false";
							relogin();
						}
					}else{
						logging = "false";
						relogin();
					}
				},
				error: function(d){
			    		logging = "false";
					relogin();
				}
			});
		}else if(logging === "pending"){
			return;
		}
	}
	
	var keepAlive = function(){
		if(!deviceToken){
			return;
		}
		
		var aliveBase = {
			"clientVersion":"3.4.1",
			"userPlt":"00",
			"sendPlt":"jf365",
			"lon":"116.298974",
			"lat":"40.051008",
			"city":"北京",
			"cityIdCde":"110100",
			"deviceToken": deviceToken,
			"attest":"-339418059",
			"longitude":"116.298974",
			"latitude":"40.051008",
			"sourceIP":"10.0.3.15",
			"deviceType":"1",
			"deviceID":deviceID,
			"c":"",
			"menuId":"4",
			"imei":deviceID,
			"txnId":"1MUI000001",
			"locationId":"290",
			"cityId":"310100"
		};
		
		$.ajax({
			url: "https://mlife.jf365.boc.cn/AppPrj/getUi.do",
			data: aliveBase,
			type: "POST",
			success: function(r){
				var d = JSON.parse(r);
				if(d.stat && d.result){
					$("body").prepend("<p>保持登陆状态:" + d.result + "</p>");
					if(d.result != "操作成功"){
						if(sign !== ""){
							window.relogin();
						}
					}
				}else{
					$("body").prepend("<p>保持登陆状态:" + d.result + "</p>");
				}
			},
			error: function(d){
				$("body").prepend("<p>保持登陆状态:" + d.result + "</p>");
			}
		});
	}
	
	setTimeout(init, 1000);
	setInterval(keepAlive, 60000);
})();
